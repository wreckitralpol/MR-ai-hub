<script>
document.addEventListener('DOMContentLoaded', () => {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // CONFIGURATION: Paste your published Exec URL here (https://script.google.com/macros/s/AKfycbzg3XLz6401_6OMfKOofVdejfMt8C0ipcD6Laj6dPCNlJXsLtT8doXS66Js3gK7xkrqIg/exec)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const googleWebAppUrl = 'https://script.google.com/macros/s/AKfycbzg3XLz6401_6OMfKOofVdejfMt8C0ipcD6Laj6dPCNlJXsLtT8doXS66Js3gK7xkrqIg/exec';

    // Cache DOM elements
    const mainSections = document.querySelectorAll('.main-section');
    const navLinks      = document.querySelectorAll('.nav-link, .nav-link-cta');
    const verificationTableBody = document.getElementById('verification-table-body');
    const confirmSubmissionBtn  = document.getElementById('confirm-submission-btn');
    const submissionForm        = document.getElementById('submission-form');
    const confirmationModal     = document.getElementById('confirmation-modal');
    let allProjects = [];

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // NAVIGATION (unchanged)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showSection(hash) {
        mainSections.forEach(s => s.classList.add('hidden'));
        const sec = document.querySelector(hash) || document.querySelector('#home');
        sec.classList.remove('hidden');
        if (hash === '#verification') fetchProjectsFromSheet();
        navLinks.forEach(l => l.classList.toggle('active', l.getAttribute('href') === hash));
    }
    navLinks.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const h = link.getAttribute('href');
            history.pushState(null, null, h);
            showSection(h);
        });
    });
    window.addEventListener('popstate', () => showSection(window.location.hash || '#home'));

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1) FETCH & RENDER SUBMITTED PROJECTS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchProjectsFromSheet() {
        verificationTableBody.innerHTML =
            `<tr><td colspan="6" class="text-center p-8 text-slate-500">Loading projectsâ€¦</td></tr>`;
        try {
            // ðŸ”‘ Use CORS mode and GET
            const res = await fetch(googleWebAppUrl, { method: 'GET', mode: 'cors' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const sheetData = await res.json();

            allProjects = sheetData.map(p => ({
                id: p.ProjectID,
                projectTitle: p['Project Title'],
                submissionDate: new Date(p['SubmissionDate']).toISOString().split('T')[0],
                submitter: p.Submitters.split('\n')[0].split('(')[0].trim(),
                status: p.Status,
                monthlyHoursSaved: parseFloat(p['Monthly Hours Saved']),
                fullSubmitterInfo: p.Submitters
            }));
            renderVerificationTable();

        } catch (err) {
            console.error('Failed fetching projects:', err);
            verificationTableBody.innerHTML =
              `<tr><td colspan="6" class="text-center p-8 text-red-600 font-bold">
                 Could not load project data. Please check the script deployment permissions.
               </td></tr>`;
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2) SUBMIT FORM â†’ POST TO SHEETS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    confirmSubmissionBtn.addEventListener('click', () => {
        confirmSubmissionBtn.disabled = true;
        confirmSubmissionBtn.textContent = 'Submittingâ€¦';

        // Build your payload exactly as before
        const payload = buildPayloadFromForm();

        // ðŸ”‘ Use CORS mode, POST, and send JSON
        fetch(googleWebAppUrl, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        })
        .then(() => {
            alert('Success! Your project has been submitted for review.');
            resetFormAndState();
            showSection('#verification');
            fetchProjectsFromSheet();
        })
        .catch(err => {
            console.error('Error submitting to Google Sheet:', err);
            alert('There was an error submitting your project. Please try again.');
        })
        .finally(() => {
            confirmSubmissionBtn.disabled = false;
            confirmSubmissionBtn.textContent = 'Confirm & Submit';
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
        });
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // INITIALIZE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    showSection(window.location.hash || '#home');
});

// (You can leave your helper functions like renderVerificationTable(),
//  buildPayloadFromForm(), resetFormAndState(), and your modals/event
//  wiring exactly as they wereâ€”only the two fetch calls above needed to change.)
</script>
